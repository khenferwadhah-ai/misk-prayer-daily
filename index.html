<script>
fetch("times.json")
  .then(r => r.json())
  .then(data => {

    let prayers = data.prayers;
    const container = document.getElementById("prayerTable");

    function buildTable(){
      container.innerHTML = "";

      prayers.forEach(p => {
        const row = document.createElement("div");
        row.className = "row prayer-row";
        row.dataset.name = p.name;
        row.dataset.time = p.time;
        row.innerHTML = `<span>${p.name}</span><span>${p.time}</span>`;
        container.appendChild(row);
      });
    }

    function calculateImsak(fajr){
      const [h,m] = fajr.split(":").map(Number);
      const d = new Date();
      d.setHours(h, m - 10, 0, 0);
      return String(d.getHours()).padStart(2,"0") + ":" +
             String(d.getMinutes()).padStart(2,"0");
    }

    function apply31Jan2026(){
      const now = new Date();
      const today =
        now.getFullYear()+"-"+
        String(now.getMonth()+1).padStart(2,"0")+"-"+
        String(now.getDate()).padStart(2,"0");

      if(today === "2026-01-31"){

        const fajrTime = "06:10";

        prayers = [
          {name:"الإمساك", time: calculateImsak(fajrTime)},
          {name:"الفجر", time: fajrTime},
          {name:"الظهر", time:"12:50"},
          {name:"العصر", time:"15:37"},
          {name:"المغرب", time:"18:03"},
          {name:"العشاء", time:"19:23"}
        ];

        buildTable();
      }
    }

    function updateClock(){

      const now = new Date();

      document.getElementById("clock").innerText =
        now.toLocaleTimeString("ar-DZ",{hour12:false});

      document.getElementById("gregorian").innerText =
        now.toLocaleDateString("ar-DZ",{
          weekday:"long", year:"numeric", month:"long", day:"numeric"
        });

      const cutoff = new Date("2026-02-01T00:00:00");
      document.getElementById("hijri").innerText =
        now < cutoff
        ? "12 شعبان 1447"
        : now.toLocaleDateString("ar-SA-u-ca-islamic",
          {day:"numeric",month:"long",year:"numeric"});

      const currentMinutes = now.getHours()*60 + now.getMinutes();

      let next = null;
      let diff = null;

      document.querySelectorAll(".prayer-row").forEach(r=>{
        r.classList.remove("next-prayer");
      });

      for(let p of prayers){
        if(p.name === "الإمساك") continue;

        const [h,m] = p.time.split(":").map(Number);
        const total = h*60 + m;

        if(total > currentMinutes){
          next = p;
          diff = total - currentMinutes;
          break;
        }
      }

      if(!next){
        next = prayers.find(p=>p.name!=="الإمساك");
        const [h,m] = next.time.split(":").map(Number);
        diff = (24*60 - currentMinutes) + (h*60+m);
      }

      const hrs = Math.floor(diff/60);
      const mins = diff % 60;

      document.getElementById("countdown").innerText =
        `الصلاة القادمة: ${next.name} بعد ${hrs}س ${mins}د`;

      document.querySelectorAll(".prayer-row").forEach(r=>{
        if(r.dataset.name === next.name){
          r.classList.add("next-prayer");
        }
      });
    }

    buildTable();
    apply31Jan2026();
    setInterval(updateClock,1000);
    updateClock();
  });
</script>